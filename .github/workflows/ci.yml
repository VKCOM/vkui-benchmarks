# This workflow will run tests using node and then publish a package to GitHub Packages when a release is created
# For more information see: https://help.github.com/actions/language-and-framework-guides/publishing-nodejs-packages

name: Run Benchmarks

on: workflow_dispatch

jobs:
  build:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        app: ["vkui", "mui", "yandex"]

    steps:
      - uses: actions/checkout@v2
      - name: Setup node
        uses: actions/setup-node@v1
        with:
          node-version: "14"

      - run: yarn
      - run: npx lerna bootstrap --scope @vkui-benchmarks/${{ matrix.app }}-benchmark
      - run: yarn build:${{ matrix.app }}
      - name: deploy to surge
        env:
          SURGE_LOGIN: ${{ secrets.SURGE_LOGIN }}
          SURGE_TOKEN: ${{ secrets.SURGE_TOKEN }}
        run: npx surge ./apps/${{ matrix.app }}-benchmark/build ${{ matrix.app }}-benchmark.surge.sh
        

  benchmark:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        app: ["vkui", "mui", "yandex"]

    needs: build

    steps:
      - name: Lighthouse CI Action
        uses: treosh/lighthouse-ci-action@v7
        with:
          temporaryPublicStorage: true
          urls: |
            https://${{ matrix.app }}-benchmark.surge.sh
            https://${{ matrix.app }}-benchmark.surge.sh?mode=modals
            https://${{ matrix.app }}-benchmark.surge.sh?mode=burn
